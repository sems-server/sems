name: Build distribution packages

on:
  push:
    branches:
      - '**'
  pull_request:
    branches:
      - '**'

jobs:
  rpm_test_build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Build image based on RHEL7
        run: docker build -t sems_el7 -f Dockerfile-rhel7 .

      - name: Build image based on RHEL8
        run: docker build -t sems_el8 -f Dockerfile-rhel8 .

      - name: Build image based on RHEL9
        run: docker build -t sems_el9 -f Dockerfile-rhel9 .

      - name: Build image based on RHEL10
        run: docker build -t sems_el10 -f Dockerfile-rhel10 .

  deb_test_build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Build image based on Debian 11
        run: docker build -t sems_deb11 -f Dockerfile-debian11 .

      - name: Build image based on Debian 12
        run: docker build -t sems_deb12 -f Dockerfile-debian12 .

      - name: Build image based on Debian 13
        run: docker build -t sems_deb13 -f Dockerfile-debian13 .

  asan_test:
    runs-on: ubuntu-latest
    name: ASAN Memory Check

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake g++ libspandsp-dev libspeex-dev \
            libgsm1-dev libopus-dev libssl-dev python3-dev libev-dev \
            libevent-dev libxml2-dev libcurl4-openssl-dev libhiredis-dev

      - name: Configure with ASAN
        run: |
          mkdir build && cd build
          cmake .. -DSEMS_USE_ASAN=ON -DCMAKE_BUILD_TYPE=Debug

      - name: Build
        run: cmake --build build -j$(nproc)

      - name: Run tests with ASAN
        run: |
          cd build
          ASAN_OPTIONS=detect_leaks=1:halt_on_error=0 ctest -V
        continue-on-error: true
